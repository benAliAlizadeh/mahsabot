#!/bin/bash
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                    MahsaBot Installer v1.0                        â•‘
# â•‘          Telegram VPN Subscription Management Bot               â•‘
# â•‘                   github.com/benAliAlizadeh/mahsabot                    â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'
BOLD='\033[1m'

INSTALL_DIR="/var/www/mahsabot"
DB_NAME="mahsabot_db"
DB_USER="mahsabot_user"

print_banner() {
    clear
    echo -e "${CYAN}"
    echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "  â•‘         ğŸ¤– MahsaBot Installer          â•‘"
    echo "  â•‘     VPN Subscription Bot v1.0        â•‘"
    echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo ""
}

log_info()  { echo -e "${GREEN}[âœ“]${NC} $1"; }
log_warn()  { echo -e "${YELLOW}[!]${NC} $1"; }
log_error() { echo -e "${RED}[âœ—]${NC} $1"; }
log_step()  { echo -e "\n${BLUE}${BOLD}â”â”â” $1 â”â”â”${NC}\n"; }

check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "Ø§ÛŒÙ† Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ root Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯"
        echo "sudo bash mahsabot.sh"
        exit 1
    fi
}

check_os() {
    if ! grep -qi 'ubuntu\|debian' /etc/os-release 2>/dev/null; then
        log_warn "Ø§ÛŒÙ† Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø±Ø§ÛŒ Ubuntu/Debian Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡. Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø±ÙˆÛŒ ØªÙˆØ²ÛŒØ¹â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ù…Ø´Ú©Ù„ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯."
    fi
}

install_dependencies() {
    log_step "Ù†ØµØ¨ Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§"
    
    apt-get update -y > /dev/null 2>&1
    log_info "Ù„ÛŒØ³Øª Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯"
    
    apt-get install -y apache2 mysql-server php php-mysql php-curl php-xml php-soap php-gd php-mbstring php-gmp php-bcmath unzip curl git certbot python3-certbot-apache > /dev/null 2>&1
    log_info "Apache, MySQL, PHP Ùˆ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ Ù†ØµØ¨ Ø´Ø¯"
    
    systemctl enable apache2 mysql
    systemctl start apache2 mysql
    log_info "Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ ÙØ¹Ø§Ù„ Ø´Ø¯Ù†Ø¯"
}

setup_database() {
    log_step "Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³"
    
    echo -e "${CYAN}Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¯ÛŒØªØ§Ø¨ÛŒØ³${NC} (Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± $DB_USER):"
    read -s DB_PASS
    echo ""
    
    if [[ -z "$DB_PASS" ]]; then
        DB_PASS=$(openssl rand -base64 16 | tr -d '=/+')
        log_info "Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± ØªØµØ§Ø¯ÙÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯: ${YELLOW}${DB_PASS}${NC}"
        log_warn "Ø§ÛŒÙ† Ø±Ù…Ø² Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯!"
    fi
    
    mysql -e "CREATE DATABASE IF NOT EXISTS \`${DB_NAME}\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
    mysql -e "CREATE USER IF NOT EXISTS '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASS}';"
    mysql -e "GRANT ALL PRIVILEGES ON \`${DB_NAME}\`.* TO '${DB_USER}'@'localhost';"
    mysql -e "FLUSH PRIVILEGES;"
    
    log_info "Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ${DB_NAME} Ùˆ Ú©Ø§Ø±Ø¨Ø± ${DB_USER} Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
}

download_bot() {
    log_step "Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø±Ø¨Ø§Øª"
    
    if [[ -d "$INSTALL_DIR" ]]; then
        log_warn "Ù…Ø³ÛŒØ± ${INSTALL_DIR} Ø§Ø² Ù‚Ø¨Ù„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯"
        echo -e "Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø´ÙˆØ¯ØŸ (y/N)"
        read -r confirm
        if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
            log_error "Ù†ØµØ¨ Ù„ØºÙˆ Ø´Ø¯"
            exit 1
        fi
        rm -rf "$INSTALL_DIR"
    fi
    
    git clone https://github.com/benAliAlizadeh/mahsabot.git "$INSTALL_DIR" 2>/dev/null || {
        mkdir -p "$INSTALL_DIR"
        log_warn "Ú©Ù„ÙˆÙ† Ø§Ø² Ú¯ÛŒØª Ù†Ø§Ù…ÙˆÙÙ‚. ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ú©Ù¾ÛŒ Ø´ÙˆÙ†Ø¯."
    }
    
    chown -R www-data:www-data "$INSTALL_DIR"
    chmod -R 755 "$INSTALL_DIR"
    log_info "ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¯Ø± ${INSTALL_DIR} Ù†ØµØ¨ Ø´Ø¯"
}

configure_bot() {
    log_step "Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø±Ø¨Ø§Øª"
    
    echo -e "${CYAN}ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…:${NC}"
    read -r BOT_TOKEN
    
    echo -e "${CYAN}Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ø§Ø¯Ù…ÛŒÙ†:${NC}"
    read -r ADMIN_ID
    
    echo -e "${CYAN}Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø¨Ø§Øª${NC} (Ø¨Ø¯ÙˆÙ† @):"
    read -r BOT_USERNAME
    
    echo -e "${CYAN}Ø¯Ø§Ù…Ù†Ù‡ Ø³Ø±ÙˆØ±${NC} (Ù…Ø«Ø§Ù„: example.com):"
    read -r BOT_DOMAIN
    
    BOT_URL="https://${BOT_DOMAIN}/"
    
    # Create config.php
    cat > "${INSTALL_DIR}/config.php" << PHPEOF
<?php
// MahsaBot Configuration - Generated by installer
define('ESI_DB_HOST', 'localhost');
define('ESI_DB_NAME', '${DB_NAME}');
define('ESI_DB_USER', '${DB_USER}');
define('ESI_DB_PASS', '${DB_PASS}');

define('ESI_BOT_TOKEN', '${BOT_TOKEN}');
define('ESI_ADMIN_ID', ${ADMIN_ID});
define('ESI_BOT_USERNAME', '${BOT_USERNAME}');
define('ESI_BOT_URL', '${BOT_URL}');
define('ESI_BOT_DOMAIN', '${BOT_DOMAIN}');

date_default_timezone_set('Asia/Tehran');
define('ESI_DEBUG', false);
PHPEOF

    log_info "ÙØ§ÛŒÙ„ config.php Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
}

setup_ssl() {
    log_step "Ø¯Ø±ÛŒØ§ÙØª Ú¯ÙˆØ§Ù‡ÛŒ SSL"
    
    echo -e "Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ SSL (Let's Encrypt) Ù†ØµØ¨ Ø´ÙˆØ¯ØŸ (Y/n)"
    read -r ssl_confirm
    
    if [[ "$ssl_confirm" != "n" && "$ssl_confirm" != "N" ]]; then
        echo -e "${CYAN}Ø§ÛŒÙ…ÛŒÙ„${NC} (Ø¨Ø±Ø§ÛŒ Let's Encrypt):"
        read -r LE_EMAIL
        
        certbot --apache -d "$BOT_DOMAIN" --non-interactive --agree-tos -m "$LE_EMAIL" 2>/dev/null && {
            log_info "Ú¯ÙˆØ§Ù‡ÛŒ SSL Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù†ØµØ¨ Ø´Ø¯"
        } || {
            log_warn "Ù†ØµØ¨ SSL Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯Ø³ØªÛŒ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯."
        }
    fi
}

configure_apache() {
    log_step "Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Apache"
    
    cat > /etc/apache2/sites-available/mahsabot.conf << APEOF
<VirtualHost *:80>
    ServerName ${BOT_DOMAIN}
    DocumentRoot ${INSTALL_DIR}
    
    <Directory ${INSTALL_DIR}>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
    
    # Deny access to sensitive files
    <FilesMatch "\.(php|sh|sql)$">
        <If "%{REQUEST_URI} !~ m#^/(bot\.php|gateway/|services/subscription\.php|web/)#">
            Require all denied
        </If>
    </FilesMatch>
    
    ErrorLog \${APACHE_LOG_DIR}/mahsabot_error.log
    CustomLog \${APACHE_LOG_DIR}/mahsabot_access.log combined
</VirtualHost>
APEOF

    a2ensite mahsabot.conf > /dev/null 2>&1
    a2enmod rewrite > /dev/null 2>&1
    systemctl reload apache2
    log_info "Apache Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø´Ø¯"
}

create_database_tables() {
    log_step "Ø³Ø§Ø®Øª Ø¬Ø¯Ø§ÙˆÙ„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³"
    
    php "${INSTALL_DIR}/setup/schema.php" && {
        log_info "Ø¬Ø¯Ø§ÙˆÙ„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
    } || {
        log_warn "Ø³Ø§Ø®Øª Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ø² Ø·Ø±ÛŒÙ‚ PHP Ù†Ø§Ù…ÙˆÙÙ‚. ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯..."
        # Run inline
        php -r "
        require_once '${INSTALL_DIR}/config.php';
        require_once '${INSTALL_DIR}/core/database.php';
        require_once '${INSTALL_DIR}/setup/schema.php';
        \$db = new mysqli(ESI_DB_HOST, ESI_DB_USER, ESI_DB_PASS, ESI_DB_NAME);
        \$db->set_charset('utf8mb4');
        esi_create_schema(\$db);
        esi_seed_defaults(\$db);
        echo 'OK';
        "
        log_info "Ø¬Ø¯Ø§ÙˆÙ„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
    }
}

set_webhook() {
    log_step "ØªÙ†Ø¸ÛŒÙ… Webhook"
    
    WEBHOOK_URL="${BOT_URL}bot.php"
    RESULT=$(curl -s "https://api.telegram.org/bot${BOT_TOKEN}/setWebhook?url=${WEBHOOK_URL}")
    
    if echo "$RESULT" | grep -q '"ok":true'; then
        log_info "Webhook ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯: ${WEBHOOK_URL}"
    else
        log_error "ØªÙ†Ø¸ÛŒÙ… Webhook Ù†Ø§Ù…ÙˆÙÙ‚: ${RESULT}"
    fi
}

setup_cron_jobs() {
    log_step "ØªÙ†Ø¸ÛŒÙ… Cron Jobs"
    
    CRON_FILE="/etc/cron.d/mahsabot"
    cat > "$CRON_FILE" << CRONEOF
# MahsaBot Cron Jobs
SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# Broadcast messages (every minute)
* * * * * www-data php ${INSTALL_DIR}/services/broadcaster.php >> /var/log/mahsabot_cron.log 2>&1

# Verify TRX payments (every 2 minutes)
*/2 * * * * www-data php ${INSTALL_DIR}/services/tron_verifier.php >> /var/log/mahsabot_cron.log 2>&1

# Check expired subscriptions (every 6 hours)
0 */6 * * * www-data php ${INSTALL_DIR}/services/expiry_monitor.php >> /var/log/mahsabot_cron.log 2>&1

# Distribute gifts (every 5 minutes)
*/5 * * * * www-data php ${INSTALL_DIR}/services/gift_distributor.php >> /var/log/mahsabot_cron.log 2>&1

# Daily report (8:00 AM Tehran time)
0 8 * * * www-data php ${INSTALL_DIR}/services/report_sender.php >> /var/log/mahsabot_cron.log 2>&1
CRONEOF

    chmod 644 "$CRON_FILE"
    log_info "Cron Jobs ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯"
}

copy_lib_files() {
    log_step "Ú©Ù¾ÛŒ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§"
    
    mkdir -p "${INSTALL_DIR}/lib/phpqrcode"
    
    # phpqrcode will be included in the repo
    if [[ -f "${INSTALL_DIR}/lib/phpqrcode/phpqrcode.php" ]]; then
        log_info "Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ QR Code Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª"
    else
        log_warn "Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ phpqrcode ÛŒØ§ÙØª Ù†Ø´Ø¯. QR Code ØºÛŒØ±ÙØ¹Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯."
    fi
}

show_summary() {
    echo ""
    echo -e "${GREEN}${BOLD}"
    echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "  â•‘     âœ… Ù†ØµØ¨ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!      â•‘"
    echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo ""
    echo -e "  ${CYAN}ğŸ“‚ Ù…Ø³ÛŒØ± Ù†ØµØ¨:${NC}   ${INSTALL_DIR}"
    echo -e "  ${CYAN}ğŸŒ Ø¢Ø¯Ø±Ø³ Ø±Ø¨Ø§Øª:${NC}  ${BOT_URL}"
    echo -e "  ${CYAN}ğŸ—ƒï¸  Ø¯ÛŒØªØ§Ø¨ÛŒØ³:${NC}    ${DB_NAME}"
    echo -e "  ${CYAN}ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø± DB:${NC}    ${DB_USER}"
    echo ""
    echo -e "  ${YELLOW}âš ï¸  Ù†Ú©Ø§Øª Ù…Ù‡Ù…:${NC}"
    echo "  â”œ Ø±Ù…Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø±Ø§ Ø¯Ø± Ø¬Ø§ÛŒ Ø§Ù…Ù† Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯"
    echo "  â”œ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ SSL ÙØ¹Ø§Ù„ Ø§Ø³Øª"
    echo "  â”œ ÙØ§ÛŒÙ„ config.php Ø±Ø§ Ø¨Ø§Ø²Ø¨ÛŒÙ†ÛŒ Ú©Ù†ÛŒØ¯"
    echo "  â”” Ø±Ø¨Ø§Øª Ø±Ø§ Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø§ /start ØªØ³Øª Ú©Ù†ÛŒØ¯"
    echo ""
    echo -e "  ${BLUE}ğŸ“š Ù…Ø³ØªÙ†Ø¯Ø§Øª:${NC} https://github.com/benAliAlizadeh/mahsabot"
    echo ""
}

# â”€â”€ Uninstall â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
uninstall() {
    print_banner
    echo -e "${RED}${BOLD}âš ï¸  Ø­Ø°Ù MahsaBot${NC}"
    echo ""
    echo -e "Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ØŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†Ø¯."
    echo -e "Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ (y/N)"
    read -r confirm
    
    if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
        rm -rf "$INSTALL_DIR"
        rm -f /etc/cron.d/mahsabot
        rm -f /etc/apache2/sites-available/mahsabot.conf
        a2dissite mahsabot.conf > /dev/null 2>&1
        mysql -e "DROP DATABASE IF EXISTS \`${DB_NAME}\`;" 2>/dev/null
        mysql -e "DROP USER IF EXISTS '${DB_USER}'@'localhost';" 2>/dev/null
        systemctl reload apache2
        log_info "MahsaBot Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯"
    else
        log_info "Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯"
    fi
}

# â”€â”€ Main Menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
main() {
    check_root
    check_os
    print_banner
    
    echo -e "  ${BOLD}Ø¹Ù…Ù„ÛŒØ§Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:${NC}"
    echo ""
    echo -e "  ${GREEN}1)${NC} Ù†ØµØ¨ Ú©Ø§Ù…Ù„ MahsaBot"
    echo -e "  ${YELLOW}2)${NC} Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§"
    echo -e "  ${RED}3)${NC} Ø­Ø°Ù MahsaBot"
    echo -e "  ${BLUE}4)${NC} ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬Ø¯Ø¯ Webhook"
    echo -e "  ${CYAN}5)${NC} Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³"
    echo -e "  0) Ø®Ø±ÙˆØ¬"
    echo ""
    echo -ne "  Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§: "
    read -r choice
    
    case $choice in
        1)
            install_dependencies
            setup_database
            download_bot
            configure_bot
            configure_apache
            setup_ssl
            create_database_tables
            copy_lib_files
            setup_cron_jobs
            set_webhook
            show_summary
            ;;
        2)
            log_step "Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ"
            cd "$INSTALL_DIR" && git pull 2>/dev/null || log_warn "Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø² Ú¯ÛŒØª Ù†Ø§Ù…ÙˆÙÙ‚"
            chown -R www-data:www-data "$INSTALL_DIR"
            log_info "ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯"
            ;;
        3)
            uninstall
            ;;
        4)
            if [[ -f "${INSTALL_DIR}/config.php" ]]; then
                BOT_TOKEN=$(php -r "require '${INSTALL_DIR}/config.php'; echo ESI_BOT_TOKEN;")
                BOT_URL=$(php -r "require '${INSTALL_DIR}/config.php'; echo ESI_BOT_URL;")
                set_webhook
            else
                log_error "ÙØ§ÛŒÙ„ config.php ÛŒØ§ÙØª Ù†Ø´Ø¯"
            fi
            ;;
        5)
            BACKUP_FILE="/root/mahsabot_backup_$(date +%Y%m%d_%H%M%S).sql"
            if [[ -f "${INSTALL_DIR}/config.php" ]]; then
                DB_PASS_BACKUP=$(php -r "require '${INSTALL_DIR}/config.php'; echo ESI_DB_PASS;")
                mysqldump -u "$DB_USER" -p"$DB_PASS_BACKUP" "$DB_NAME" > "$BACKUP_FILE"
                log_info "Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¯Ø± ${BACKUP_FILE} Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯"
            else
                log_error "ÙØ§ÛŒÙ„ config.php ÛŒØ§ÙØª Ù†Ø´Ø¯"
            fi
            ;;
        0)
            exit 0
            ;;
        *)
            log_error "Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø§Ù…Ø¹ØªØ¨Ø±"
            ;;
    esac
}

main "$@"
